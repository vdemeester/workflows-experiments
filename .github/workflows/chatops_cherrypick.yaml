name: Cherry Pick Command

on:
  repository_dispatch:
    types: [cherry-pick-command]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  cherry-pick:
    runs-on: ubuntu-latest
    steps:
      - name: Add reaction to trigger comment
        uses: peter-evans/create-or-update-comment@e8674b075228eee787fea43ef493e45ece1004c9 # v5.0.0
        with:
          token: ${{ secrets.SBR_BOT_TOKEN }}
          repository: ${{ github.event.client_payload.github.payload.repository.full_name }}
          comment-id: ${{ github.event.client_payload.github.payload.comment.id }}
          reactions: "+1"

      - name: Get target branch from command args
        id: parse-args
        run: |
          TARGET_BRANCH="${{ github.event.client_payload.slash_command.args.unnamed.arg1 }}"

          if [ -z "$TARGET_BRANCH" ]; then
            echo "error=true" >> $GITHUB_OUTPUT
            echo "message=Missing target branch. Usage: /cherry-pick <target-branch>" >> $GITHUB_OUTPUT
          else
            echo "branch=$TARGET_BRANCH" >> $GITHUB_OUTPUT
            echo "error=false" >> $GITHUB_OUTPUT
          fi

      - name: Comment on error
        if: steps.parse-args.outputs.error == 'true'
        uses: peter-evans/create-or-update-comment@e8674b075228eee787fea43ef493e45ece1004c9 # v5.0.0
        with:
          token: ${{ secrets.SBR_BOT_TOKEN }}
          repository: ${{ github.event.client_payload.github.payload.repository.full_name }}
          issue-number: ${{ github.event.client_payload.github.payload.issue.number }}
          body: |
            ❌ **Cherry-pick failed**: ${{ steps.parse-args.outputs.message }}

            **Usage**: `/cherry-pick <target-branch>`
            **Example**: `/cherry-pick release-v1.0`

      - name: Checkout repository
        if: steps.parse-args.outputs.error == 'false'
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          token: ${{ secrets.SBR_BOT_TOKEN }}
          fetch-depth: 0

      - name: Perform cherry-pick
        if: steps.parse-args.outputs.error == 'false'
        id: cherry-pick
        continue-on-error: true
        uses: vendoo/gha-cherry-pick@cf5917fb432a6a459e27afdde89a4ce67448c37d # v1
        env:
          GITHUB_TOKEN: ${{ secrets.SBR_BOT_TOKEN }}
          PR_NUMBER: ${{ github.event.client_payload.pull_request.number }}

      - name: Get cherry-pick logs on failure
        if: steps.parse-args.outputs.error == 'false' && steps.cherry-pick.outcome == 'failure'
        id: get-logs
        continue-on-error: true
        env:
          GH_TOKEN: ${{ secrets.SBR_BOT_TOKEN }}
        run: |
          # Get the current job logs and extract cherry-pick output
          LOGS=$(gh run view ${{ github.run_id }} --log --repo ${{ github.repository }} 2>&1 | grep -A 50 "Perform cherry-pick" | tail -30 || echo "Unable to fetch logs")
          echo $LOGS
          # Escape for GitHub output
          EOF=$(dd if=/dev/urandom bs=15 count=1 status=none | base64)
          echo "logs<<$EOF" >> $GITHUB_OUTPUT
          echo "$LOGS" >> $GITHUB_OUTPUT
          echo "$EOF" >> $GITHUB_OUTPUT

      - name: Comment on success
        if: steps.parse-args.outputs.error == 'false' && steps.cherry-pick.outcome == 'success'
        uses: peter-evans/create-or-update-comment@e8674b075228eee787fea43ef493e45ece1004c9 # v5.0.0
        with:
          token: ${{ secrets.SBR_BOT_TOKEN }}
          repository: ${{ github.event.client_payload.github.payload.repository.full_name }}
          issue-number: ${{ github.event.client_payload.github.payload.issue.number }}
          body: |
            ✅ **Cherry-pick successful!**

            A new pull request has been created to cherry-pick this change to `${{ steps.parse-args.outputs.branch }}`.

            Please review and merge the cherry-pick PR.

      - name: Comment on failure
        if: steps.parse-args.outputs.error == 'false' && steps.cherry-pick.outcome == 'failure'
        uses: peter-evans/create-or-update-comment@e8674b075228eee787fea43ef493e45ece1004c9 # v5.0.0
        with:
          token: ${{ secrets.SBR_BOT_TOKEN }}
          repository: ${{ github.event.client_payload.github.payload.repository.full_name }}
          issue-number: ${{ github.event.client_payload.github.payload.issue.number }}
          body: |
            ❌ **Cherry-pick failed!**

            The automatic cherry-pick to `${{ steps.parse-args.outputs.branch }}` failed.

            **Error output:**
            ```
            ${{ steps.get-logs.outputs.logs }}
            ```

            **Possible causes:**
            - The PR is not merged yet (cherry-pick requires merged PRs)
            - Merge conflicts exist between this PR and the target branch
            - The target branch `${{ steps.parse-args.outputs.branch }}` does not exist

            **Next steps:**
            - Check the [action logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for complete details
            - If the PR is not merged, merge it first and try again
            - If there are conflicts, you'll need to manually cherry-pick this PR
