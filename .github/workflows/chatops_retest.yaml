name: Rerun Failed Actions
on:
  repository_dispatch:
    types: [retest-command]

jobs:
  retest:
    runs-on: ubuntu-latest
    steps:
      - name: Show environment
        run: env | sort

      - name: Show GitHub context
        env:
          GITHUB_CONTEXT: ${{ toJson(github) }}
        run: echo "$GITHUB_CONTEXT"

      - name: Get PR SHA
        id: get-sha
        env:
          GH_TOKEN: ${{ secrets.SBR_BOT_TOKEN }}
        run: |
          PR_NUMBER=${{ github.event.client_payload.pull_request.number }}
          echo "PR_NUMBER=$PR_NUMBER" >> $GITHUB_OUTPUT
          SHA=$(gh pr view $PR_NUMBER --repo ${{ github.repository }} --json headRefOid --jq '.headRefOid')
          echo "SHA=$SHA" >> $GITHUB_OUTPUT
          echo "Retrieved SHA: $SHA for PR #$PR_NUMBER"

      - name: Get failed runs
        id: get-runs
        env:
          GH_TOKEN: ${{ secrets.SBR_BOT_TOKEN }}
        run: |
          SHA=${{ steps.get-sha.outputs.SHA }}
          FAILED_RUNS=$(gh run list --repo ${{ github.repository }} --commit $SHA --json databaseId,status,conclusion --jq '.[] | select(.conclusion=="failure") | .databaseId' | tr '\n' ' ')
          echo "FAILED_RUNS=$FAILED_RUNS" >> $GITHUB_OUTPUT
          echo "Failed run IDs: $FAILED_RUNS"

      - name: Rerun failed runs
        if: steps.get-runs.outputs.FAILED_RUNS != ''
        env:
          GH_TOKEN: ${{ secrets.SBR_BOT_TOKEN }}
        run: |
          for RUN_ID in ${{ steps.get-runs.outputs.FAILED_RUNS }}; do
            echo "Rerunning failed jobs for run ID: $RUN_ID"
            gh run rerun $RUN_ID --failed --repo ${{ github.repository }}
          done

      - name: Add success reaction
        if: success()
        uses: peter-evans/create-or-update-comment@e8674b075228eee787fea43ef493e45ece1004c9 # v5.0.0
        with:
          token: ${{ secrets.SBR_BOT_TOKEN }}
          repository: ${{ github.event.client_payload.github.payload.repository.full_name }}
          comment-id: ${{ github.event.client_payload.github.payload.comment.id }}
          reactions: hooray

      - name: Add failure comment
        if: failure()
        uses: peter-evans/create-or-update-comment@e8674b075228eee787fea43ef493e45ece1004c9 # v5.0.0
        with:
          token: ${{ secrets.SBR_BOT_TOKEN }}
          repository: ${{ github.event.client_payload.github.payload.repository.full_name }}
          issue-number: ${{ github.event.client_payload.pull_request.number }}
          body: |
            > /retest

            Failed to rerun failed actions. Check the [logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for more details.
